// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Employee {
  id                           String                            @id @default(cuid())
  priority                     Priority
  reviewed                     Boolean
  email                        String                            @unique
  salaries                     Salary[]
  deelEmployee                 DeelEmployee?
  keeperTestFeedback           KeeperTestFeedback[]              @relation("employee")
  checkIn30DaysScheduled       Boolean
  checkIn60DaysScheduled       Boolean
  checkIn80DaysScheduled       Boolean
  proposedHires                ProposedHire[]                    @relation("manager")
  proposedHiresAsTalentPartner ProposedHire[]
  keeperTestFeedbackSubmitted  KeeperTestFeedback[]              @relation("manager")
  salaryDeviationStatus        SalaryDeviationStatus?
  salaryDeviationCheckedAt     DateTime                          @default(now())
  performancePrograms          PerformanceProgram[]
  commissionBonuses            CommissionBonus[]
  ashbyInterviewScoresReceived AshbyInterviewScore[]             @relation("InterviewedEmployee")
  ashbyInterviewScoresGiven    AshbyInterviewScore[]             @relation("Interviewer")
  ashbyInterviewScoresImported Boolean                           @default(false)
  checklistItemsAssigned       PerformanceProgramChecklistItem[] @relation("ChecklistItemAssignedTo")
}

enum SalaryDeviationStatus {
  IN_SYNC
  DEVIATED
}

model DeelEmployee {
  id                    String         @id
  name                  String
  title                 String
  team                  String
  workEmail             String?        @unique
  personalEmail         String?
  managerId             String?
  manager               DeelEmployee?  @relation("manager", fields: [managerId], references: [id])
  directReports         DeelEmployee[] @relation("manager")
  topLevelManagerId     String?
  topLevelManager       DeelEmployee?  @relation("topLevelManager", fields: [topLevelManagerId], references: [id])
  topLevelDirectReports DeelEmployee[] @relation("topLevelManager")
  employee              Employee?      @relation(fields: [workEmail], references: [email])
  startDate             DateTime
}

enum Priority {
  low
  high
  medium
  pushed_to_next_quarter
  filled
}

model Salary {
  id                      String   @id @default(cuid())
  timestamp               DateTime @default(now())
  country                 String
  area                    String
  locationFactor          Float
  level                   Float
  step                    Float
  benchmark               String
  benchmarkFactor         Float
  totalSalary             Float
  bonusPercentage         Float    @default(0)
  bonusAmount             Float    @default(0)
  changePercentage        Float
  changeAmount            Float
  exchangeRate            Float
  localCurrency           String
  totalSalaryLocal        Float
  amountTakenInOptions    Float
  actualSalary            Float
  actualSalaryLocal       Float
  equityRefreshPercentage Float    @default(0)
  equityRefreshAmount     Float    @default(0)
  equityRefreshGranted    Boolean  @default(true)
  employmentCountry       String?
  employmentArea          String?
  notes                   String
  employeeId              String
  synced                  Boolean  @default(true)
  communicated            Boolean  @default(false)
  employee                Employee @relation(fields: [employeeId], references: [id])
}

enum KeeperTestRecommendation {
  STRONG_HIRE_ON_TRACK_TO_PASS_PROBATION
  AVERAGE_HIRE_NEED_TO_SEE_IMPROVEMENTS
  NOT_A_FIT_NEEDS_ESCALATING
}

enum KeeperTestRating {
  STRONG_YES
  YES
  NO
  STRONG_NO
}

model KeeperTestFeedback {
  id                    String                    @id @default(cuid())
  title                 String
  employeeId            String
  employee              Employee                  @relation("employee", fields: [employeeId], references: [id])
  managerId             String
  manager               Employee                  @relation("manager", fields: [managerId], references: [id])
  wouldYouTryToKeepThem KeeperTestRating
  whatMakesThemValuable String
  driverOrPassenger     KeeperTestRating
  proactiveToday        KeeperTestRating
  optimisticByDefault   KeeperTestRating
  areasToWatch          String
  recommendation        KeeperTestRecommendation?
  sharedWithTeamMember  Boolean
  timestamp             DateTime                  @default(now())
}

enum CyclotronQueueName {
  send_keeper_test
  send_manager_feedback
  receive_keeper_test_results
  receive_manager_feedback_results
  dead_letter
}

enum CyclotronJobState {
  running
  available
  failed
}

model CyclotronJob {
  id             String             @id @default(cuid())
  created        DateTime           @default(now())
  scheduled      DateTime           @default(now())
  queue_name     CyclotronQueueName
  lock_id        String?
  state          CyclotronJobState  @default(available)
  last_heartbeat DateTime           @default(now())
  data           Json
  failure_count  Int                @default(0)
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]

  role       String?
  banned     Boolean?  @default(false)
  banReason  String?
  banExpires DateTime?

  performanceProgramsStarted PerformanceProgram[]              @relation("ProgramStartedBy")
  checklistItemsCompleted    PerformanceProgramChecklistItem[] @relation("ChecklistItemCompletedBy")
  filesUploaded              File[]                            @relation("FileUploadedBy")
  feedbackGiven              PerformanceProgramFeedback[]      @relation("FeedbackGivenBy")

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model ProposedHire {
  id             String     @id @default(cuid())
  title          String
  managerId      String
  manager        Employee   @relation("manager", fields: [managerId], references: [id])
  talentPartners Employee[]
  priority       Priority
  hiringProfile  String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt
}

model ProcessDocument {
  id        String   @id @default("process")
  content   String   @default("")
  updatedAt DateTime @default(now()) @updatedAt
}

enum PerformanceProgramStatus {
  ACTIVE
  RESOLVED
}

enum ChecklistItemType {
  SLACK_FEEDBACK_MEETING
  EMAIL_FEEDBACK_MEETING
}

model PerformanceProgram {
  id              String                            @id @default(cuid())
  employeeId      String
  employee        Employee                          @relation(fields: [employeeId], references: [id])
  status          PerformanceProgramStatus          @default(ACTIVE)
  startedAt       DateTime                          @default(now())
  resolvedAt      DateTime?
  startedByUserId String
  startedBy       User                              @relation("ProgramStartedBy", fields: [startedByUserId], references: [id])
  checklistItems  PerformanceProgramChecklistItem[]
  feedback        PerformanceProgramFeedback[]
  createdAt       DateTime                          @default(now())
  updatedAt       DateTime                          @default(now()) @updatedAt
}

model PerformanceProgramChecklistItem {
  id                     String             @id @default(cuid())
  programId              String
  program                PerformanceProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  type                   ChecklistItemType
  completed              Boolean            @default(false)
  completedAt            DateTime?
  completedByUserId      String?
  completedBy            User?              @relation("ChecklistItemCompletedBy", fields: [completedByUserId], references: [id])
  assignedToEmployeeId   String?
  assignedTo             Employee?          @relation("ChecklistItemAssignedTo", fields: [assignedToEmployeeId], references: [id])
  dueDate                DateTime?
  files                  File[]
  notes                  String?
  lastNotificationSentAt DateTime?
  slackThreadId          String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @default(now()) @updatedAt
}

model File {
  id               String                           @id @default(cuid())
  checklistItemId  String?
  checklistItem    PerformanceProgramChecklistItem? @relation(fields: [checklistItemId], references: [id], onDelete: Cascade)
  feedbackId       String?
  feedback         PerformanceProgramFeedback?      @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  fileName         String
  fileUrl          String
  fileSize         Int
  mimeType         String
  uploadedAt       DateTime                         @default(now())
  uploadedByUserId String
  uploadedBy       User                             @relation("FileUploadedBy", fields: [uploadedByUserId], references: [id])
}

model PerformanceProgramFeedback {
  id            String             @id @default(cuid())
  programId     String
  program       PerformanceProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  feedback      String
  givenByUserId String
  givenBy       User               @relation("FeedbackGivenBy", fields: [givenByUserId], references: [id])
  files         File[]
  createdAt     DateTime           @default(now())
}

model CommissionBonus {
  id                    String   @id @default(cuid())
  employeeId            String
  employee              Employee @relation(fields: [employeeId], references: [id])
  quarter               String // Format: "2025-Q4"
  quota                 Float // Sales quota for the quarter
  attainment            Float // Actual attainment amount
  bonusAmount           Float // bonusAmount from employee's latest salary record
  calculatedAmount      Float // (attainment / quota) × bonusAmount
  exchangeRate          Float // Exchange rate from employee's latest salary
  localCurrency         String // Local currency from employee's latest salary
  calculatedAmountLocal Float // calculatedAmount × exchangeRate
  communicated          Boolean  @default(false)
  synced                Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([employeeId, quarter]) // Prevent duplicate bonuses per employee per quarter
}

model AshbyInterviewScore {
  id            String   @id @default(cuid())
  employeeId    String // The employee being interviewed
  employee      Employee @relation("InterviewedEmployee", fields: [employeeId], references: [id])
  interviewerId String // The employee who conducted the interview
  interviewer   Employee @relation("Interviewer", fields: [interviewerId], references: [id])
  rating        Int // Rating between 1 and 4
  feedback      String // Interview feedback/notes
  interviewName String? // Name of the interview (e.g., "Technical Interview", "Culture Fit")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([employeeId])
  @@index([interviewerId])
}
